name: Test Galileo SSH Connection

on:
  push:
    branches: [ main, master ]

jobs:
  ssh-test:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key, cert, and config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SLURM_PRIVATE_KEY }}" > ~/.ssh/my_key
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/my_key.pub
          echo "${{ secrets.SSH_CERTIFICATE }}" > ~/.ssh/my_key-cert.pub

          chmod 600 ~/.ssh/my_key
          chmod 644 ~/.ssh/my_key.pub ~/.ssh/my_key-cert.pub

          cat <<EOF > ~/.ssh/config
          Host galileo
              HostName ${{ secrets.SLURM_HOST }}
              User ${{ secrets.SLURM_USER }}
              IdentityFile ~/.ssh/my_key
              CertificateFile ~/.ssh/my_key-cert.pub
              IdentitiesOnly yes
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF

      - name: Test SSH Connection
        run: |
          ssh -F ~/.ssh/config galileo "hostname && whoami && date"
