name: DevOps Pipeline Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test-containerize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y dos2unix curl wget openssh-client

      - name: Prepare job.sh and definition
        run: dos2unix job.sh || true

      - name: Set up SSH keys and config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SLURM_PRIVATE_KEY }}" > ~/.ssh/my_key
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/my_key.pub
          echo "${{ secrets.SSH_CERTIFICATE }}" > ~/.ssh/my_key-cert.pub

          chmod 600 ~/.ssh/my_key
          chmod 644 ~/.ssh/my_key.pub ~/.ssh/my_key-cert.pub

          cat <<EOF > ~/.ssh/config
          Host galileo
              HostName ${{ secrets.SLURM_HOST }}
              User ${{ secrets.SLURM_USER }}
              IdentityFile ~/.ssh/my_key
              CertificateFile ~/.ssh/my_key-cert.pub
              IdentitiesOnly yes
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF

      - name: Upload files to Galileo100
        run: |
          scp -F ~/.ssh/config Singularity.def job.sh galileo:~/seproject/

      - name: Submit SLURM job
        run: |
          ssh -F ~/.ssh/config galileo "cd ~/seproject && sbatch job.sh"

      - name: Wait for job to complete
        run: sleep 60

      - name: Download output log
        run: |
          scp -F ~/.ssh/config galileo:~/seproject/grayscale_output.log .

      - name: Show job output
        run: cat grayscale_output.log

      - name: Upload job output as artifact
        uses: actions/upload-artifact@v4
        with:
          name: grayscale_output.log
          path: grayscale_output.log
