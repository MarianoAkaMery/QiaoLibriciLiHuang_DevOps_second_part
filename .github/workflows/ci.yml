name: DevOps Pipeline Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test-containerize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            cmake g++ make \
            uuid-dev libseccomp-dev pkg-config squashfs-tools cryptsetup \
            dos2unix curl wget openssh-client

      - name: Run build script
        run: ./build.sh

      - name: Run unit tests
        run: ./build/test_grayscale

      - name: Prepare job.sh
        run: dos2unix job.sh || true

      - name: Set up SSH key, cert, and config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SLURM_PRIVATE_KEY }}" > ~/.ssh/my_key
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/my_key.pub
          echo "${{ secrets.SSH_CERTIFICATE }}" > ~/.ssh/my_key-cert.pub

          chmod 600 ~/.ssh/my_key
          chmod 644 ~/.ssh/my_key.pub ~/.ssh/my_key-cert.pub

          cat <<EOF > ~/.ssh/config
          Host galileo
              HostName ${{ secrets.SLURM_HOST }}
              User ${{ secrets.SLURM_USER }}
              IdentityFile ~/.ssh/my_key
              CertificateFile ~/.ssh/my_key-cert.pub
              IdentitiesOnly yes
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF

      - name: Transfer sources to Galileo100
        run: |
          scp -F ~/.ssh/config Singularity.def job.sh galileo:~/seproject/
          scp -F ~/.ssh/config -r src/ galileo:~/seproject/
          scp -F ~/.ssh/config -r build/ galileo:~/seproject/

      - name: Build Singularity image on Galileo
        run: |
          ssh -F ~/.ssh/config galileo "
            module load singularity &&
            cd ~/seproject &&
            singularity build grayscale.sif Singularity.def
          "

      - name: Submit SLURM job
        run: |
          ssh -F ~/.ssh/config galileo "cd ~/seproject && sbatch job.sh"

      - name: Wait for SLURM job to complete
        run: sleep 60

      - name: Download result logs
        run: |
          scp -F ~/.ssh/config galileo:~/seproject/grayscale_output.log .
          scp -F ~/.ssh/config galileo:~/seproject/test_output.txt .

      - name: Show job output in logs
        run: |
          echo "===== Grayscale Output ====="
          cat grayscale_output.log
          echo "===== Test Output ====="
          cat test_output.txt

      - name: Upload output logs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: output-logs
          path: |
            grayscale_output.log
            test_output.txt
