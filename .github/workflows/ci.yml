name: DevOps Pipeline Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      SIF_NAME: grayscale.sif

    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      # ------------------------------------------------
      # 1) Build & test
      # ------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            cmake g++ make \
            uuid-dev libseccomp-dev pkg-config squashfs-tools cryptsetup \
            dos2unix curl wget openssh-client tree

      - name: Install Singularity
        run: |
          sudo apt-get update
          sudo apt-get install -y singularity-container

      - name: Clean up build folder before image build
        run: rm -rf build   

      - name: Build and test
        run: |
          ./build.sh
          ./build/test_grayscale

      # ------------------------------------------------
      # 2) Containerize (with isolated context)
      # ------------------------------------------------
      - name: Build Singularity Image (with clean context)
        run: |
          echo "Creating clean container build context..."
          mkdir singularity_context
          cp CMakeLists.txt Singularity.def job.sh singularity_context/
          for dir in src include input test; do
            if [ -d "$dir" ]; then
              cp -r "$dir" singularity_context/
            else
              echo "⚠️ Warning: Directory '$dir' not found. Skipping..."
            fi
          done

          echo "--- Singularity context structure ---"
          tree singularity_context

          cd singularity_context
          sudo singularity build "../${SIF_NAME}" Singularity.def

      - name: Upload SIF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SIF_NAME }}-${{ github.sha }}.sif
          path: ${{ env.SIF_NAME }}

      # ------------------------------------------------
      # 3) Transfer to Galileo and Submit Job
      # ------------------------------------------------
      - name: Verify Galileo Secrets
        if: ${{ !github.event.pull_request }}
        env:
          GALILEO_HOST: ${{ secrets.SLURM_HOST || secrets.GALILEO_HOST }}
          GALILEO_USER: ${{ secrets.SLURM_USER || secrets.GALILEO_USER }}
          GALILEO_KEY:  ${{ secrets.SLURM_PRIVATE_KEY || secrets.GALILEO_KEY }}
          GALILEO_CERT: ${{ secrets.SSH_CERTIFICATE || secrets.GALILEO_CERT }}
        run: |
          for var in GALILEO_HOST GALILEO_USER GALILEO_KEY; do
            if [[ -z "${!var}" ]]; then
              echo "::error::$var is not set"; exit 1
            fi
          done

      - name: Copy and check on Galileo
        if: ${{ !github.event.pull_request }}
        env:
          GALILEO_HOST: ${{ secrets.SLURM_HOST || secrets.GALILEO_HOST }}
          GALILEO_USER: ${{ secrets.SLURM_USER || secrets.GALILEO_USER }}
          GALILEO_KEY:  ${{ secrets.SLURM_PRIVATE_KEY || secrets.GALILEO_KEY }}
          GALILEO_CERT: ${{ secrets.SSH_CERTIFICATE || secrets.GALILEO_CERT }}
          SIF_NAME: grayscale.sif
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$GALILEO_KEY" > ~/.ssh/my_key
          chmod 600 ~/.ssh/my_key
          if [[ -n "$GALILEO_CERT" ]]; then
            echo "$GALILEO_CERT" > ~/.ssh/my_key-cert.pub
            chmod 644 ~/.ssh/my_key-cert.pub
          fi
          cat > ~/.ssh/config <<EOF
          Host galileo
            HostName $GALILEO_HOST
            User $GALILEO_USER
            IdentityFile ~/.ssh/my_key
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            EOF
                      [[ -n "$GALILEO_CERT" ]] && echo "  CertificateFile ~/.ssh/my_key-cert.pub" >> ~/.ssh/config

                      echo "Transferring files to Galileo..."
                      scp -r -F ~/.ssh/config "$SIF_NAME" job.sh input/ galileo:~/seproject/

                      echo "Checking container and entrypoint..."
                      ssh -F ~/.ssh/config galileo "
                        ls -lh ~/seproject/$SIF_NAME
                        singularity exec ~/seproject/$SIF_NAME /opt/app/build/convert_grayscale --help || echo '⚠️ Binary not found inside container'
                      "

      - name: Submit SLURM job and wait
        if: ${{ !github.event.pull_request }}
        env:
          GALILEO_HOST: ${{ secrets.SLURM_HOST || secrets.GALILEO_HOST }}
          GALILEO_USER: ${{ secrets.SLURM_USER || secrets.GALILEO_USER }}
        run: |
          set -euo pipefail
          JOB_ID=$(ssh -F ~/.ssh/config galileo "cd ~/seproject && sbatch job.sh" | awk '{print $4}')
          echo "SLURM job id: $JOB_ID"
          echo "Waiting for SLURM job $JOB_ID …"
          while true; do
            STATE=$(ssh -F ~/.ssh/config galileo "sacct -j $JOB_ID -n -o State | head -n 1 | awk '{print \$1}'")
            [[ -z "$STATE" ]] && STATE=PENDING
            echo "  -> current state: $STATE"
            case "$STATE" in
              PENDING|CONFIGURING|RUNNING|COMPLETING) sleep 20 ;;
              COMPLETED) echo "Job finished OK ✅"; break ;;
              FAILED|CANCELLED|TIMEOUT|NODE_FAIL|PREEMPTED)
                echo "Job finished with error state ❌"; exit 1 ;;
              *)  echo "Unknown state '$STATE' – giving up"; exit 2 ;;
            esac
          done
