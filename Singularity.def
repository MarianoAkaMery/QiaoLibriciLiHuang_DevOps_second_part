Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Yibo"
    Version "1.2"     # build-in-/tmp fix

%post
    echo "ðŸ§± Installing toolchain â€¦"
    apt-get update && apt-get install -y \
        build-essential cmake git libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    # cache gtest so we donâ€™t rebuild every run
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make -j"$(nproc)"
    cp lib/libgtest*.a /usr/lib

    # the project sources are staged here
%files
    CMakeLists.txt            /opt/app_src/
    include/                  /opt/app_src/
    src/                      /opt/app_src/
    test/                     /opt/app_src/
    input/                    /opt/app_src/
    build.sh                  /opt/app_src/
    convert_ppm.py            /opt/app_src/
    random_gen_images.py      /opt/app_src/
    LICENSE                   /opt/app_src/

%environment
    export APP_TMP=/tmp/grayscale_build   # writable workdir

%runscript
    echo "ðŸš€  Launching grayscale conversion â€¦"

    # ------------------------------------------------------------------
    # Compile once, into a tmp directory that is always writable
    if [ ! -f "$APP_TMP/build/convert_grayscale" ]; then
        echo "ðŸ”¨  First-time build inside container â€¦"
        mkdir -p  "$APP_TMP"
        cp -r /opt/app_src/* "$APP_TMP/"

        cd "$APP_TMP"
        rm -rf build CMakeCache.txt
        chmod +x build.sh
        ./build.sh
    fi

    exec "$APP_TMP/build/convert_grayscale" "$@"
