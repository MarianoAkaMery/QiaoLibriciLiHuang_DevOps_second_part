Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Yibo"
    Version "1.1"

%post
    echo "ğŸ§±  Installing system deps â€¦"
    apt-get update && apt-get install -y \
        build-essential cmake git libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    echo "âš™ï¸  Building GoogleTest manually â€¦"
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make -j$(nproc)
    cp lib/*.a /usr/lib

    echo "ğŸ“¦  Copying application sources â€¦"
    mkdir -p /opt/app
    cp -r /opt/app_src/* /opt/app/

    echo "ğŸ”¨  Configuring & compiling application â€¦"
    cd /opt/app
    chmod +x build.sh
    ./build.sh            # produces build/convert_grayscale & build/test_grayscale

    # -- optional: slim the image (~120 MB smaller)
    apt-get purge -y git libgtest-dev && apt-get autoremove -y

%files
. /opt/app_src           # context from the repo pushed by the GH runner

%environment
    export PATH=/opt/app/build:$PATH   # make binaries callable directly

%runscript
    # Default action inside the container â†’ run converter with passed args
    echo "ğŸš€  Running convert_grayscale inside container â€¦"
    exec /opt/app/build/convert_grayscale "$@"
