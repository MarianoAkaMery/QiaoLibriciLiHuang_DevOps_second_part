Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "yibo"
    Version "1.0"

%files
CMakeLists.txt /opt/app
Singularity.def /opt/app
job.sh /opt/app
src /opt/app/src
include /opt/app/include
input /opt/app/input
test /opt/app/test

%post
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    # Build Google Test
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make
    cp lib/*.a /usr/lib

    # Build the project
    mkdir -p /opt/app/build
    cd /opt/app/build
    cmake ..
    make

%environment
    export PATH=/opt/app/build:$PATH

%runscript
    exec /opt/app/build/convert_grayscale "$@"
