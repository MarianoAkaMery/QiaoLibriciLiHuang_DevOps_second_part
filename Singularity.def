Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Yibo"
    Version "1.1"   # bumped to show the fix

%post
    # -------------------------------------------------------------------------
    echo "üß± Installing system dependencies ‚Ä¶"
    apt-get update && apt-get install -y \
        build-essential cmake git libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    # -------------------------------------------------------------------------
    echo "‚öôÔ∏è  Building GoogleTest once for the container ‚Ä¶"
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make -j"$(nproc)"
    cp lib/libgtest*.a /usr/lib

    # -------------------------------------------------------------------------
    echo "üì¶  Creating application directory ‚Ä¶"
    mkdir -p /opt/app
    # nothing is copied here; sources come via the %files section

%files
    # copy **only sources & scripts**, NOT the host-side build artefacts
    CMakeLists.txt            /opt/app_src/
    include/                  /opt/app_src/
    src/                      /opt/app_src/
    test/                     /opt/app_src/
    input/                    /opt/app_src/
    build.sh                  /opt/app_src/
    convert_ppm.py            /opt/app_src/
    random_gen_images.py      /opt/app_src/
    LICENSE                   /opt/app_src/
    job.sh                    /opt/app_src/

%environment
    export PATH=/opt/app/build:$PATH

%runscript
    echo "üöÄ Running grayscale conversion inside container‚Ä¶"

    # ---------------------------------------------------------------------
    # Build on first run (or whenever artefacts are missing)
    if [ ! -f /opt/app/build/convert_grayscale ]; then
        echo "üî® Building the application from source ‚Ä¶"
        mkdir -p /opt/app
        cp -r /opt/app_src/* /opt/app/

        cd /opt/app
        # wipe any stale cache that might slip in
        rm -rf build CMakeCache.txt

        chmod +x build.sh
        ./build.sh           # creates build/ + binaries
    fi

    # ---------------------------------------------------------------------
    exec /opt/app/build/convert_grayscale "$@"
