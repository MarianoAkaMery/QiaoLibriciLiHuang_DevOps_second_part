Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "Yibo"
    Version "1.0"

%post
    echo "🧱 Installing system dependencies..."
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
        libgtest-dev \
        && rm -rf /var/lib/apt/lists/*

    echo "⚙️ Building GoogleTest manually..."
    cd /usr/src/gtest
    cmake -DCMAKE_CXX_FLAGS="-fPIC" .
    make
    cp lib/*.a /usr/lib

    echo "📦 Creating app directory..."
    mkdir -p /opt/app

%environment
    export PATH=/opt/app/build:$PATH

%runscript
    echo "🚀 Running grayscale conversion inside container..."

    if [ ! -f /opt/app/build/convert_grayscale ]; then
        echo "🔨 Building the app from source..."
        cp -r /opt/app_src/* /opt/app/
        cd /opt/app
        chmod +x build.sh
        ./build.sh
    fi

    exec /opt/app/build/convert_grayscale "$@"
